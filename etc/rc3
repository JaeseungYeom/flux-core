#!/bin/bash -e

core_dir=$(cd ${0%/*} && pwd -P)
all_dirs=$core_dir${FLUX_RC_EXTRA:+":$FLUX_RC_EXTRA"}
IFS=:
shopt -s nullglob
for rcdir in $all_dirs; do
    for rcfile in $rcdir/rc3.d/*; do
        echo running $rcfile
        $rcfile
    done
done
shopt -u nullglob

flux module remove sched-simple
flux module remove job-exec
flux module remove job-manager
flux exec -r all flux module remove job-ingest

if PERSISTDIR=$(flux getattr persist-directory 2>/dev/null); then
    /bin/true; # XXX: nothing to persist?
fi

flux module remove userdb

flux module remove cron
flux exec -r all flux module remove aggregator
flux exec -r all flux module remove barrier

flux exec -r all flux module remove job-info
flux exec -r all flux module remove kvs-watch
flux exec -r all -x 0 flux module remove kvs
if test -n "$PERSISTDIR"; then
    flux kvs getroot >${PERSISTDIR}/kvsroot.final
    flux content flush
fi
flux module remove kvs
flux module remove content-sqlite

