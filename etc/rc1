#!/bin/bash -e

pids=""

flux exec -r all flux module load barrier

flux module load content-sqlite

flux module load kvs
flux exec -r all -x 0 flux module load kvs
flux exec -r all flux module load kvs-watch

flux exec -r all flux module load job-info
flux exec -r all flux module load aggregator

flux hwloc reload & pids="$pids $!"

flux module load cron sync=hb

flux module load userdb ${FLUX_USERDB_OPTIONS}

flux exec -r all flux module load job-ingest
flux module load job-manager
flux module load job-exec
flux module load sched-simple

wait $pids

core_dir=$(cd ${0%/*} && pwd -P)
all_dirs=$core_dir${FLUX_RC_EXTRA:+":$FLUX_RC_EXTRA"}
IFS=:
shopt -s nullglob
for rcdir in $all_dirs; do
    for rcfile in $rcdir/rc1.d/*; do
	echo running $rcfile
        $rcfile
    done
done
shopt -u nullglob
